--// Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")

--// Remotes
local requestEvent = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Events"):WaitForChild("Request")
local requestFunction = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Functions"):WaitForChild("Request")

--// Config
local targetStructures = { "Petal Well", "Cryo Chamber" }
local potionsToBuy = {
    "Small Luck Potion", "Medium Luck Potion", "Large Luck Potion",
    "Small Speed Potion", "Medium Speed Potion", "Large Speed Potion",
    "Small Yield Potion", "Medium Yield Potion", "Large Yield Potion"
}

local potionInterval = 60 -- every 60s

--// Variables
local localPlayer = Players.LocalPlayer
local plotFolder = nil
local autoEnabled = false

local lastCollect = tick()
local lastPotionCycle = tick()
local inPotionMode = false

--// UI Setup (top-left simple timer)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AutoFarmUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = localPlayer:WaitForChild("PlayerGui")

local timerLabel = Instance.new("TextLabel")
timerLabel.Size = UDim2.new(0, 220, 0, 30)
timerLabel.Position = UDim2.new(0, 10, 0, 10)
timerLabel.BackgroundTransparency = 0.4
timerLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
timerLabel.BorderSizePixel = 0
timerLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
timerLabel.Font = Enum.Font.GothamSemibold
timerLabel.TextSize = 16
timerLabel.Text = "Potion Timer: Ready"
timerLabel.Parent = screenGui

--// Detect your plot
local function detectPlot()
    local plots = Workspace:WaitForChild("Plots")
    for i = 1, 9 do
        local plot = plots:FindFirstChild(tostring(i))
        if plot and plot:FindFirstChild("Placed") then
            plotFolder = plot.Placed
            StarterGui:SetCore("SendNotification", {Title="AutoFarm", Text="✅ Found Plot "..i, Duration=5})
            break
        end
    end
end
detectPlot()

--// Toggle with P
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.P then
        autoEnabled = not autoEnabled
        StarterGui:SetCore("SendNotification", {
            Title = "AutoFarm",
            Text = autoEnabled and "🟢 Enabled" or "🔴 Disabled",
            Duration = 4
        })
    end
end)

--// Check if potion has stock
local function potionHasStock(potionName)
    local guiPath = localPlayer.PlayerGui:FindFirstChild("Windows")
    if not guiPath then return false end

    local listFrame = guiPath:FindFirstChild("Gear") and guiPath.Gear:FindFirstChild("ListFrame") and guiPath.Gear.ListFrame:FindFirstChild("List")
    if not listFrame then return false end

    local potionFrame = listFrame:FindFirstChild(potionName)
    if not potionFrame then return false end

    local stockLabel = potionFrame:FindFirstChild("Container") and potionFrame.Container:FindFirstChild("Stock")
    if not stockLabel then return false end

    local stockText = stockLabel.Text or stockLabel.ContentText
    if not stockText then return false end

    return not stockText:match("Out of Stock")
end

--// Function to run potion mode (with stock check)
local function buyPotionsSafe()
    inPotionMode = true
    timerLabel.Text = "Potion Mode..."
    StarterGui:SetCore("SendNotification", {Title="AutoFarm", Text="⚗️ Potion mode started...", Duration=4})

    task.spawn(function()
        local anyBought = false

        for _, potion in ipairs(potionsToBuy) do
            if potionHasStock(potion) then
                for i = 1, 20 do
                    pcall(function()
                        requestFunction:InvokeServer("PurchaseGear", potion)
                    end)
                    task.wait(0.1)
                end
                anyBought = true
            else
                print("⚠️ Skipping " .. potion .. " (Out of Stock!)")
            end
        end

        if anyBought then
            StarterGui:SetCore("SendNotification", {Title="AutoFarm", Text="✅ Potion mode complete.", Duration=4})
        else
            StarterGui:SetCore("SendNotification", {Title="AutoFarm", Text="⚠️ All potions out of stock! Skipping...", Duration=5})
        end

        lastPotionCycle = tick() -- reset after done
        inPotionMode = false
        lastCollect = tick() -- reset collect timing too
    end)
end

--// Main Loop
RunService.Heartbeat:Connect(function()
    if not autoEnabled or not plotFolder then return end
    local now = tick()

    -- Enter potion mode every interval
    if not inPotionMode and (now - lastPotionCycle >= potionInterval) then
        buyPotionsSafe()
        return
    end

    if inPotionMode then return end

    -- Countdown display
    local remaining = math.max(0, potionInterval - math.floor(now - lastPotionCycle))
    timerLabel.Text = "Potion in: " .. remaining .. "s"

    -- Collect every 5s
    if now - lastCollect >= 1 then
        for _, name in ipairs(targetStructures) do
            local structure = plotFolder:FindFirstChild(name)
            if structure then
                requestEvent:FireServer("CollectStructure", structure)
            end
        end
        lastCollect = now
    end

    -- Manual gather spam
    requestEvent:FireServer("ManualGather")
end)
