--// Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")

--// Remotes
local requestEvent = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Events"):WaitForChild("Request")
local requestFunction = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Functions"):WaitForChild("Request")

--// Config
local targetStructures = { "Petal Well", "Cryo Chamber" }
local potionsToBuy = {
    "Small Luck Potion", "Medium Luck Potion", "Large Luck Potion",
    "Small Speed Potion", "Medium Speed Potion", "Large Speed Potion",
    "Small Yield Potion", "Medium Yield Potion", "Large Yield Potion"
}

--// Variables
local localPlayer = Players.LocalPlayer
local plotFolder = nil
local autoEnabled = false

local lastCollect = tick()
local inPotionMode = false
local nextPotionTime = tick() -- when potion mode will run again (dynamic from restock timer)

--// UI Setup (top-left simple timer)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AutoFarmUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = localPlayer:WaitForChild("PlayerGui")

local timerLabel = Instance.new("TextLabel")
timerLabel.Size = UDim2.new(0, 220, 0, 30)
timerLabel.Position = UDim2.new(0, 10, 0, 10)
timerLabel.BackgroundTransparency = 0.4
timerLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
timerLabel.BorderSizePixel = 0
timerLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
timerLabel.Font = Enum.Font.GothamSemibold
timerLabel.TextSize = 16
timerLabel.Text = "Potion Timer: Ready"
timerLabel.Parent = screenGui

--// Detect your plot
local function detectPlot()
    local plots = Workspace:WaitForChild("Plots")
    for i = 1, 9 do
        local plot = plots:FindFirstChild(tostring(i))
        if plot and plot:FindFirstChild("Placed") then
            plotFolder = plot.Placed
            StarterGui:SetCore("SendNotification", {Title="AutoFarm", Text="✅ Found Plot "..i, Duration=5})
            break
        end
    end
end
detectPlot()

--// Toggle with P
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.P then
        autoEnabled = not autoEnabled
        StarterGui:SetCore("SendNotification", {
            Title = "AutoFarm",
            Text = autoEnabled and "🟢 Enabled" or "🔴 Disabled",
            Duration = 4
        })
    end
end)

--// Check if potion has stock
local function potionHasStock(potionName)
    local guiPath = localPlayer.PlayerGui:FindFirstChild("Windows")
    if not guiPath then return false end

    local listFrame = guiPath:FindFirstChild("Gear") and guiPath.Gear:FindFirstChild("ListFrame") and guiPath.Gear.ListFrame:FindFirstChild("List")
    if not listFrame then return false end

    local potionFrame = listFrame:FindFirstChild(potionName)
    if not potionFrame then return false end

    local stockLabel = potionFrame:FindFirstChild("Container") and potionFrame.Container:FindFirstChild("Stock")
    if not stockLabel then return false end

    local stockText = stockLabel.Text or stockLabel.ContentText
    if not stockText then return false end

    return not stockText:match("Out of Stock")
end

--// Parse countdown timer ("Next Restock: mm:ss")
local function getRestockTime()
    local countdown = localPlayer.PlayerGui:FindFirstChild("Windows") and localPlayer.PlayerGui.Windows:FindFirstChild("Gear") and localPlayer.PlayerGui.Windows.Gear:FindFirstChild("Countdown")
    if not countdown then return 300 end -- fallback 5 min
    local txt = countdown.Text or countdown.ContentText
    if not txt then return 300 end

    local mm, ss = txt:match("(%d+):(%d+)")
    if mm and ss then
        return tonumber(mm) * 60 + tonumber(ss)
    end
    return 300
end

--// Function to run potion mode (with stock check + restock timer)
local function buyPotionsSafe()
    inPotionMode = true
    timerLabel.Text = "Potion Mode..."
    StarterGui:SetCore("SendNotification", {Title="AutoFarm", Text="⚗️ Potion mode started...", Duration=4})

    task.spawn(function()
        local anyBought = false

        for _, potion in ipairs(potionsToBuy) do
            if potionHasStock(potion) then
                for i = 1, 20 do
                    pcall(function()
                        requestFunction:InvokeServer("PurchaseGear", potion)
                    end)
                    task.wait(0.1)
                end
                anyBought = true
            end
        end

        if anyBought then
            StarterGui:SetCore("SendNotification", {Title="AutoFarm", Text="✅ Potion mode complete.", Duration=4})
        else
            StarterGui:SetCore("SendNotification", {Title="AutoFarm", Text="⚠️ No potions in stock! Waiting for restock...", Duration=5})
        end

        -- calculate when to retry based on countdown
        local restockSeconds = getRestockTime()
        nextPotionTime = tick() + restockSeconds

        inPotionMode = false
        lastCollect = tick() -- reset farming loop timer
    end)
end

--// Main Loop
RunService.Heartbeat:Connect(function()
    if not autoEnabled or not plotFolder then return end
    local now = tick()

    -- Always read the actual countdown text
    local countdownLabel = localPlayer.PlayerGui.Windows.Gear:FindFirstChild("Countdown")
    local countdownText = countdownLabel and (countdownLabel.Text or countdownLabel.ContentText)

    -- Parse mm:ss if possible
    local mm, ss = countdownText and countdownText:match("(%d+):(%d+)")
    local remaining = (mm and ss) and (tonumber(mm) * 60 + tonumber(ss)) or 0

    -- Update UI
    if remaining > 0 then
        timerLabel.Text = "Potion in: " .. remaining .. "s"
    else
        timerLabel.Text = "Potion in: Ready!"
    end

    -- Potion mode trigger
    if not inPotionMode then
        local anyStock = false
        for _, potion in ipairs(potionsToBuy) do
            if potionHasStock(potion) then
                anyStock = true
                break
            end
        end

        -- If any stock is available or the countdown is 0 → run potion mode
        if anyStock or remaining == 0 then
            buyPotionsSafe()
            return
        end
    end

    if inPotionMode then return end

    -- Collect every 5s
    if now - lastCollect >= 5 then
        for _, name in ipairs(targetStructures) do
            local structure = plotFolder:FindFirstChild(name)
            if structure then
                requestEvent:FireServer("CollectStructure", structure)
            end
        end
        lastCollect = now
    end

    -- Manual gather
    requestEvent:FireServer("ManualGather")
end)

